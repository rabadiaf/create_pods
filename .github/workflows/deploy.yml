name: Deploy dummy pod via Ansible

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: âœï¸ Write kubeconfig from secret
        # Esto crea ./kubeconfig.embedded.yaml en el workspace
        run: |
          echo "${{ secrets.KUBECONFIG_CONTENT }}" > kubeconfig.embedded.yaml

      - name: ğŸ› ï¸ Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible curl
          curl -LO "https://dl.k8s.io/release/v1.30.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: âœ… Verify kubectl
        run: kubectl version --client

      - name: ğŸš€ Run Ansible playbook
        # Importante: KUBECONFIG apunta al archivo que creamos
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig.embedded.yaml
        run: |
          ansible-playbook playbook.yml
